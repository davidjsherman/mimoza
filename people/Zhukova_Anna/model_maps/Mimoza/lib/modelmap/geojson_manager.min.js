var MARGIN=156,MAP_DIMENSION_SIZE=512,EDGE=0,SPECIES=1,COMPARTMENT=3,REACTION=2,BG_SPECIES=4,BG_REACTION=5,BG_COMPARTMENT=6,BG=[BG_SPECIES,BG_REACTION,BG_COMPARTMENT],TRANSPORT="transport to outside",INNER_TRANSPORT="inside transport",MIN_LABEL_SIZE=10,MAX_LABEL_SIZE=16;function pnt2layer(s,K,E,B,o,i,k,c,D,m,t,l,a,H){var S=B.geometry.coordinates,f=Math.pow(2,o),J=B.properties.w;if(EDGE==B.properties.type){var q={color:B.properties.color,opacity:1,weight:Math.min(Math.min(J/2,10),4),lineCap:"round",lineJoin:"round",clickable:false,fill:false,zIndexOffset:0,riseOnHover:false};return L.polyline(S.map(function(e){return s.unproject(e,1)}),q)}if(SPECIES==B.properties.type||BG_SPECIES==B.properties.type){J/=Math.sqrt(2)}var I=S[0],G=S[1],n=-1!==BG.indexOf(B.properties.type),q={name:B.properties.name,title:B.properties.name,alt:B.properties.name,id:B.properties.id,color:BG_COMPARTMENT!=B.properties.type?"white":B.properties.color,fillColor:B.properties.color,fillOpacity:BG_COMPARTMENT==B.properties.type?0:(n?0.3:1),opacity:1,weight:BG_COMPARTMENT!=B.properties.type?(n?0:Math.min(1,J/10*f)):4,fill:true,clickable:!n,zIndexOffset:n?6:0,riseOnHover:!n},Q=(BG_COMPARTMENT==B.properties.type||COMPARTMENT==B.properties.type)?B.properties.h:J,C=new L.LatLngBounds(s.unproject([I-J,G+Q],1),s.unproject([I+J,G-Q],1)),R=s.unproject([I,G],1),b=C.getNorthEast(),j=C.getSouthWest(),M=J*40075000*Math.cos(R.lat*(Math.PI/180))/Math.pow(2,c+8);if(BG_COMPARTMENT==B.properties.type||COMPARTMENT==B.properties.type){if(k[2]==null||(BG_COMPARTMENT==B.properties.type&&D==B.properties.c_id||COMPARTMENT==B.properties.type&&D==B.properties.id)){k[2]=R}}if(BG_REACTION==B.properties.type){return L.rectangle(C,q)}if(BG_SPECIES==B.properties.type){return L.circle(R,M,q)}var v=null;if(REACTION==B.properties.type||COMPARTMENT==B.properties.type||BG_COMPARTMENT==B.properties.type){v=L.rectangle(C,q)}else{if(SPECIES==B.properties.type){v=L.circle(R,M,q)}else{return null}}k[0][0]=k[0][0]==null?j.lat:Math.min(k[0][0],j.lat);k[0][1]=k[0][1]==null?j.lng:Math.max(k[0][1],j.lng);k[1][0]=k[1][0]==null?b.lat:Math.max(k[1][0],b.lat);k[1][1]=k[1][1]==null?b.lng:Math.min(k[1][1],b.lng);var u=undefined,N=undefined;function p(h){if(!H.hasOwnProperty(h)){H[h]=L.featureGroup()}var e=H[h];e.addLayer(highlightCircle(R,M));s.on("popupopen",function(r){if(r.popup===u){if(s.hasLayer(E)){K.addLayer(e)}}});s.on("popupclose",function(r){if(r.popup===u){K.removeLayer(e)}})}if(BG_COMPARTMENT!=B.properties.type){u=getPopup(B,m,t);u.setLatLng(R);v.bindPopup(u);if(SPECIES==B.properties.type){p(B.properties.id)}[B.properties.name,B.properties.id,B.properties.t].forEach(function(e){if(e){if(!l.hasOwnProperty(e)){l[e]=u}if(!a.hasOwnProperty(e)){a[e]=[o,i]}}});N=getLabel(B);v.bindLabel(N,{direction:"auto",opacity:1})}v=L.featureGroup([v]);var T={},O=null,g=null;for(var F=o;F<=i;F++){if(g==null){var A=Math.pow(2,F);g=Q*A;O=J*A}else{g*=2;O*=2}if(g>=MIN_LABEL_SIZE){var d=Math.min(Math.max(Math.round(g/2),MIN_LABEL_SIZE),MAX_LABEL_SIZE);var U=L.marker(R,{icon:L.divIcon({className:"element-label",html:'<span style="font-size:'+d+"px;line-height:"+(d+1)+"px;color:"+(BG_COMPARTMENT==B.properties.type?B.properties.color:"black")+'">'+(REACTION==B.properties.type?B.properties.id:B.properties.name)+"</span>",iconSize:[O,g-g%(d+1)],zIndexOffset:0,riseOnHover:false,riseOffset:0})});if(u!=undefined){U.bindPopup(u)}if(N!=undefined){U.bindLabel(N,{direction:"auto",opacity:1})}T[F]=U;if(d==14){for(var P=F+1;P<=i;P++){T[P]=U}break}}}if(typeof s.getZoom()!=="undefined"){if(T.hasOwnProperty(s.getZoom())){v.addLayer(T[s.getZoom()])}}else{if(T.hasOwnProperty(o)){v.addLayer(T[o])}}if(u!=undefined){v.bindPopup(u)}if(N!=undefined){v.bindLabel(N,{direction:"auto",opacity:1})}s.on("zoomend",function(h){for(F in T){v.removeLayer(T[F])}F=s.getZoom();if(T.hasOwnProperty(F)){v.addLayer(T[F])}});if(COMPARTMENT==B.properties.type){s.on("zoomend",function(r){var h=s.getBounds();if(s.getZoom()>c+2&&s.getBounds().intersects(C)&&(s.getZoom()==s.getMaxZoom()||C.contains(h.getSouthWest())&&C.contains(h.getNorthEast()))){window.location.href="?id="+B.properties.id}})}return v}function matchesCompartment(a,b){if(TRANSPORT===a){return typeof b.properties.tr!=="undefined"&&b.properties.tr&&(typeof b.properties.inner==="undefined"||!b.properties.inner)}if(INNER_TRANSPORT===a){return typeof b.properties.tr!=="undefined"&&b.properties.tr&&(typeof b.properties.inner!=="undefined"&&b.properties.inner)}return(typeof b.properties.tr==="undefined"||!b.properties.tr)&&(typeof b.properties.inner==="undefined"||!b.properties.inner)}function getFilteredJson(b,j,m,e,p,q,g,d,o,l,a,k,f){var h={},i=$("#"+o),c=i.width()-2,n=i.height()-2;return L.geoJson(e,{pointToLayer:function(r,s){return pnt2layer(b,j,m,r,g,d,l,a,k,c,n,p,q,h)},filter:function(s,r){return f(s)},onEachFeature:function(s,r){s.layer=r}})}function loadGeoJson(b,o,f,d,i,g,l,j,k,m,h,a,n){var c=getFilteredJson(b,g,i,o,k,m,f,d,l,h,a,n==null?j:n,function(p){return(typeof p.properties.ub==="undefined"||!p.properties.ub)&&matchesCompartment(j,p)}),e=getFilteredJson(b,g,i,o,k,m,f,d,l,h,a,n==null?j:n,function(p){return(typeof p.properties.ub!=="undefined"&&p.properties.ub)&&matchesCompartment(j,p)});if(typeof b.getZoom()==="undefined"&&f<=a&&a<=d||f<=b.getZoom()&&b.getZoom()<=d){g.addLayer(c);if(b.hasLayer(i)){g.addLayer(e)}}if(f>a||d<b.getMaxZoom()){b.on("zoomend",function(p){if(f<=b.getZoom()&&b.getZoom()<=d){g.addLayer(c);if(b.hasLayer(i)){g.addLayer(e)}}else{g.removeLayer(c);g.removeLayer(e)}})}b.on("overlayadd",function(p){if(p.layer===i&&(f<=b.getZoom()&&b.getZoom()<=d)){g.addLayer(e)}});b.on("overlayremove",function(p){if(p.layer===i&&(f<=b.getZoom()&&b.getZoom()<=d)){g.removeLayer(e)}});return[c.getLayers().length>0,e.getLayers().length>0]};