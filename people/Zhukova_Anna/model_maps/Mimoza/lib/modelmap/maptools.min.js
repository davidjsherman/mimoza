var UB_LAYER_NAME="<i>Ubiquitous metabolites</i>",OUT_TR_LAYER_NAME="<i>Transport to outside</i>",IN_TR_LAYER_NAME="<i>Inner transport</i>",LEAFLET_POPUP_MARGIN=10,ALL_COMPARTMENTS="all_comp_view";function adjustMapSize(b){var d=50,e=256,c=Math.max(e,Math.round(($(window).width()-d)*0.8)),a=Math.max(e,Math.round(($(window).height()-d)*0.7));return adjustMapDivSize(b,c,a)}function adjustMapDivSize(d,f,b){var c=$("#"+d),e=c.height(),a=c.width();if(a!=f||e!=b){c.css({height:b,width:f});$(".leaflet-popup").css({maxHeight:b,maxWidth:f});$(".leaflet-popup-content").css({maxHeight:b-LEAFLET_POPUP_MARGIN,maxWidth:f-LEAFLET_POPUP_MARGIN})}return Math.min(f,b)}function getTiles(b,c,a){return L.tileLayer(b,{continuousWorld:true,noWrap:true,tileSize:256,maxZoom:a,minZoom:c,tms:true,updateWhenIdle:true,reuseTiles:true})}function handlePopUpClosing(b){var a=null;b.on("popupopen",function(c){a=c.popup});b.on("dragstart",function(c){if(a){b.closePopup(a);a.options.keepInView=false;b.openPopup(a);a.options.keepInView=true;a=null}})}function updateMapBounds(c,f,e){c[0][0]=c[0][0]==null?f[0][0]:Math.min(c[0][0],f[0][0]);c[0][1]=c[0][1]==null?f[0][1]:Math.max(c[0][1],f[0][1]);c[1][0]=c[1][0]==null?f[1][0]:Math.max(c[1][0],f[1][0]);c[1][1]=c[1][1]==null?f[1][1]:Math.min(c[1][1],f[1][1]);var a=c[1][0]-c[0][0],d=c[0][1]-c[1][1],b=Math.max(a,d)*0.1;c[0][0]-=b;c[0][1]+=b;c[1][0]+=b;c[1][1]-=b;e.setMaxBounds(c)}function addAttribution(b){var a=L.control.attribution({position:"bottomleft",prefix:false});a.addAttribution('<p><b>Zoom in/out</b> to see more/less details.</p><p><b>Click</b> on elements to see their annotations.</p><p><b>Show/Hide</b> elements in the map settings <span class="explanation">(on top right)</span>.</p>');a.addTo(b)}function initializeMap(J,g,r,k){var j=adjustMapSize(g),F=[],G=Math.max(1,Math.round(j/MAP_DIMENSION_SIZE)),c=G+1,t=c+1,z=t+5,D=L.layerGroup(),o={},p={},B=getParameter("id"),I=getParameter("zoom"),h=I==null?c:t,n=null,y;if(r&&typeof Object.keys(r)!=="undefined"&&Object.keys(r).length>0&&(B==null||!r.hasOwnProperty(B))){B=r.hasOwnProperty(ALL_COMPARTMENTS)?ALL_COMPARTMENTS:Object.keys(r)[0]}if(B!=null){p[B]=r[B];y=J[B];if(B in k){n=k[B]}var f=$("#menu_"+B);console.log(f);f.css("font-weight","Bold");f.click(function(){return false});$(".my-link").unbind("click")}if(I!=null&&!r.hasOwnProperty(I)){I=null}if(typeof y==="undefined"||y.length<=0){return null}var C=getTiles("lib/modelmap/white.jpg",G,z),K=getTiles("lib/modelmap/gray.jpg",G,z),A=L.layerGroup(),M=L.layerGroup(),H=L.layerGroup();F.push(D);F.push(C);F.push(H);F.push(A);F.push(M);var w=L.map(g,{maxZoom:z,minZoom:n!=null?G-1:G,zoom:h,attributionControl:false,padding:[MARGIN,MARGIN],layers:F,crs:L.CRS.Simple});handlePopUpClosing(w);var q={},b={},u=I==null?c:z,l=[[null,null],[null,null]],x=[[null,null],[null,null],null],E=false,m=false,d=false,e;function a(N,Q,O,P){e=loadGeoJson(w,N,Q,O,D,H,g,B,q,b,P,G,I);E|=e[1];e=loadGeoJson(w,N,Q,O,D,A,g,TRANSPORT,q,b,P,G,I);E|=e[1];d|=e[0]||e[1];e=loadGeoJson(w,N,Q,O,D,M,g,INNER_TRANSPORT,q,b,P,G,I);E|=e[1];m|=e[0]||e[1]}a(y[0],G,z,x);a(y[1],G,c,l);if(h>=t){a(y[2],t,z,l)}updateMapBounds(l,x,w);if(x[2]!=undefined){w.setView(x[2],h)}else{w.setView([0,0],h)}var s=$("#"+g);s.bind("resize",function(){var O=s.height(),N=s.width();$(".leaflet-popup").css({maxHeight:O,maxWidth:N});$(".leaflet-popup-content").css({maxHeight:O-LEAFLET_POPUP_MARGIN,maxWidth:N-LEAFLET_POPUP_MARGIN});w.invalidateSize();w.setView(w.getCenter(),w.getZoom())});if(E){o[UB_LAYER_NAME]=D}if(d){o[OUT_TR_LAYER_NAME]=A}if(m){o[IN_TR_LAYER_NAME]=M}var i={"White background":C,"Gray background":K},v=L.control.layers(i,o);v.addTo(w);initializeAutocomplete(q,b,w);w.on("zoomend",function(O){if(n!=null&&w.getZoom()==w.getMinZoom()){window.location.href="?id="+n+(B==null?"":("&zoom="+B))}if(w.getZoom()>u){a(y[2],t,z,l);updateMapBounds(l,x,w);var N=false;if(!o.hasOwnProperty(UB_LAYER_NAME)&&E){o[UB_LAYER_NAME]=D;N=true}if(!o.hasOwnProperty(IN_TR_LAYER_NAME)&&m){o[IN_TR_LAYER_NAME]=M;N=true}if(N){v.removeFrom(w);v=L.control.layers(i,o);v.addTo(w)}u=z;initializeAutocomplete(q,b,w)}});return w}function initializeAutocomplete(a,c,d){var b=document.getElementById("search_form");if(b!==null){var e=$("#tags");e.autocomplete({source:Object.keys(a),autoFocus:true});e.keypress(function(g){var f=g.keyCode||g.which;if(f===$.ui.keyCode.ENTER){search(d,a,c);g.preventDefault()}});b.onclick=function(){search(d,a,c)}}}function overlay(){var b=document.getElementById("overlay");var c=$("#embed-size-width"),a=$("#embed-size-height");update_embed_value(c.val(),a.val());b.style.visibility=(b.style.visibility==="visible")?"hidden":"visible";c.focusout(function(){var d=800;if(c.val()){var e=parseInt(c.val());if(!isNaN(e)&&e>0){d=e}else{c.val(d)}}else{c.val(d)}update_embed_value(d,a.val())});a.focus(function(){a.select()});c.focus(function(){c.select()});a.focusout(function(){var e=800;if(a.val()){var d=parseInt(a.val());if(!isNaN(d)&&d>0){e=d}else{a.val(e)}}else{a.val(e)}update_embed_value(c.val(),e)});$("#embed-html-snippet").focus(function(){$(this).select()})}function getParameter(b){var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}}function update_embed_value(b,d){var a=getParameter(),c=$("#embed-url").val();if(a){c+="?id="+a}$("#embed-html-snippet").val('<iframe src="'+c+'" width="'+b+'" height="'+d+'" frameborder="0" style="border:0"></iframe>')};