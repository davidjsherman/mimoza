var UB_LAYER_NAME="<i>Ubiquitous metabolites</i>",OUT_TR_LAYER_NAME="<i>Transport to outside</i>",IN_TR_LAYER_NAME="<i>Inner transport</i>",LEAFLET_POPUP_MARGIN=10,ALL_COMPARTMENTS="all_comp_view";function adjustMapSize(b){var d=50,e=256,c=Math.max(e,Math.round(($(window).width()-4*d))),a=Math.max(e,Math.round(($(window).height()-4*d)));return adjustMapDivSize(b,c,a)}function adjustMapDivSize(d,f,b){var c=$("#"+d),e=c.height(),a=c.width();if(a!=f||e!=b){c.css({height:b,width:f});$(".leaflet-popup").css({maxHeight:b,maxWidth:f});$(".leaflet-popup-content").css({maxHeight:b-LEAFLET_POPUP_MARGIN,maxWidth:f-LEAFLET_POPUP_MARGIN})}return Math.min(f,b)}function getTiles(b,c,a){return L.tileLayer(b,{continuousWorld:true,noWrap:true,tileSize:256,maxZoom:a,minZoom:c,tms:true,updateWhenIdle:true,reuseTiles:true})}function handlePopUpClosing(b){var a=null;b.on("popupopen",function(c){a=c.popup});b.on("dragstart",function(c){if(a){b.closePopup(a);a.options.keepInView=false;b.openPopup(a);a.options.keepInView=true;a=null}})}function updateMapBounds(c,f,e){c[0][0]=c[0][0]==null?f[0][0]:Math.min(c[0][0],f[0][0]);c[0][1]=c[0][1]==null?f[0][1]:Math.max(c[0][1],f[0][1]);c[1][0]=c[1][0]==null?f[1][0]:Math.max(c[1][0],f[1][0]);c[1][1]=c[1][1]==null?f[1][1]:Math.min(c[1][1],f[1][1]);var a=c[1][0]-c[0][0],d=c[0][1]-c[1][1],b=Math.max(a,d)*0.1;c[0][0]-=b;c[0][1]+=b;c[1][0]+=b;c[1][1]-=b;e.setMaxBounds(c)}function addAttribution(b){var a=L.control.attribution({position:"bottomleft",prefix:false});a.addAttribution('<p><b>Zoom in/out</b> to see more/less details.</p><p><b>Click</b> on elements to see their annotations.</p><p><b>Show/Hide</b> elements in the map settings <span class="explanation">(on top right)</span>.</p>');a.addTo(b)}function initializeMap(K,h,s,l){var k=adjustMapSize(h),G=[],H=Math.max(1,Math.round(k/MAP_DIMENSION_SIZE)),d=H+1,u=d+1,A=u+5,E=L.layerGroup(),p={},q={},C=getParameter("id"),J=getParameter("zoom"),i=J==null?d:u,o=null,z;if(s&&typeof Object.keys(s)!=="undefined"&&Object.keys(s).length>0&&(C==null||!s.hasOwnProperty(C))){C=s.hasOwnProperty(ALL_COMPARTMENTS)?ALL_COMPARTMENTS:Object.keys(s)[0]}if(C!=null){q[C]=s[C];z=K[C];if(C in l){o=l[C]}var g=$(".menu_"+C);g.css("font-weight","Bold");g.click(function(){return false})}if(J!=null&&!s.hasOwnProperty(J)){J=null}if(typeof z==="undefined"||z.length<=0){return null}var D=getTiles("lib/modelmap/white.jpg",H,A),M=getTiles("lib/modelmap/gray.jpg",H,A),B=L.layerGroup(),N=L.layerGroup(),I=L.layerGroup();G.push(E);G.push(D);G.push(I);G.push(B);G.push(N);var x=L.map(h,{maxZoom:A,minZoom:o!=null?H-1:H,zoom:i,attributionControl:false,padding:[MARGIN,MARGIN],layers:G,crs:L.CRS.Simple});handlePopUpClosing(x);var r={},b={},v=J==null?d:A,m=[[null,null],[null,null]],y=[[null,null],[null,null],null],F=false,n=false,e=false,f;function a(c,R,P,Q){f=loadGeoJson(x,c,R,P,E,I,h,C,r,b,Q,H,J);F|=f[1];f=loadGeoJson(x,c,R,P,E,B,h,TRANSPORT,r,b,Q,H,J);F|=f[1];e|=f[0]||f[1];f=loadGeoJson(x,c,R,P,E,N,h,INNER_TRANSPORT,r,b,Q,H,J);F|=f[1];n|=f[0]||f[1]}a(z[0],H,A,y);a(z[1],H,d,m);if(i>=u){a(z[2],u,A,m)}updateMapBounds(m,y,x);if(y[0]!=undefined&&y[1]!=undefined){if(y[2]!=undefined){x.setView(y[2],i)}else{var O=new L.LatLngBounds(y[0],y[1]).getCenter();x.setView(O,i)}}else{x.setView([0,0],i)}var t=$("#"+h);t.bind("resize",function(){var P=t.height(),c=t.width();$(".leaflet-popup").css({maxHeight:P,maxWidth:c});$(".leaflet-popup-content").css({maxHeight:P-LEAFLET_POPUP_MARGIN,maxWidth:c-LEAFLET_POPUP_MARGIN});x.invalidateSize();x.setView(x.getCenter(),x.getZoom())});if(F){p[UB_LAYER_NAME]=E}if(e){p[OUT_TR_LAYER_NAME]=B}if(n){p[IN_TR_LAYER_NAME]=N}var j={"White background":D,"Gray background":M},w=L.control.layers(j,p);w.addTo(x);initializeAutocomplete(r,b,x,h);x.on("zoomend",function(P){if(o!=null&&x.getZoom()==x.getMinZoom()){window.location.href="?id="+o+(C==null?"":("&zoom="+C))}if(x.getZoom()>v){a(z[2],u,A,m);updateMapBounds(m,y,x);var c=false;if(!p.hasOwnProperty(UB_LAYER_NAME)&&F){p[UB_LAYER_NAME]=E;c=true}if(!p.hasOwnProperty(IN_TR_LAYER_NAME)&&n){p[IN_TR_LAYER_NAME]=N;c=true}if(c){w.removeFrom(x);w=L.control.layers(j,p);w.addTo(x)}v=A;initializeAutocomplete(r,b,x,h)}});return x}function initializeAutocomplete(a,d,e,c){var b=document.getElementById("search_form_"+c);if(b!==null){var f=$("#tags_"+c);f.autocomplete({source:Object.keys(a),autoFocus:true});f.keypress(function(h){var g=h.keyCode||h.which;if(g===$.ui.keyCode.ENTER){search(e,a,d,c);h.preventDefault()}});b.onclick=function(){search(e,a,d,c)}}}function overlay(){var b=document.getElementById("overlay");var c=$("#embed-size-width"),a=$("#embed-size-height");update_embed_value(c.val(),a.val());b.style.visibility=(b.style.visibility==="visible")?"hidden":"visible";c.focusout(function(){var d=800;if(c.val()){var e=parseInt(c.val());if(!isNaN(e)&&e>0){d=e}else{c.val(d)}}else{c.val(d)}update_embed_value(d,a.val())});a.focus(function(){a.select()});c.focus(function(){c.select()});a.focusout(function(){var e=800;if(a.val()){var d=parseInt(a.val());if(!isNaN(d)&&d>0){e=d}else{a.val(e)}}else{a.val(e)}update_embed_value(c.val(),e)});$("#embed-html-snippet").focus(function(){$(this).select()})}function getParameter(b){var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}}function update_embed_value(b,d){var a=getParameter(),c=$("#embed-url").val();if(a){c+="?id="+a}$("#embed-html-snippet").val('<iframe src="'+c+'" width="'+b+'" height="'+d+'" frameborder="0" style="border:0"></iframe>')};